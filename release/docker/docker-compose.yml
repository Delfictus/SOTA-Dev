##############################################################################
# PRISM4D Demo — Docker Compose
#
# Provides SSH access to a sandboxed PRISM4D demo environment with
# full activity auditing to the host filesystem.
#
# Start:   docker compose up -d
# Stop:    docker compose down
# Logs:    docker compose logs -f
# Audit:   tail -f /var/log/prism4d-audit/commands.log
# Access:  ssh demo@localhost -p 2222  (password: demo)
#
# For remote access: ssh demo@<your-workstation-ip> -p 2222
##############################################################################

services:
  prism4d-demo:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: prism4d-demo
    hostname: prism4d

    # GPU access via NVIDIA Container Toolkit
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
        limits:
          cpus: "8"
          memory: 16G

    # SSH port mapping — client connects to port 2222 on the host
    ports:
      - "2222:22"

    # Volumes:
    #   - Audit logs: bind-mount to host so YOU can read them, demo user CANNOT
    #   - Samples: read-only topology files for the demo
    volumes:
      - /var/log/prism4d-audit:/var/log/prism4d-audit:rw
      - demo-results:/home/demo/results

    # Security: no privileged mode, drop dangerous capabilities
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - DAC_OVERRIDE
      - SYS_CHROOT
      - AUDIT_WRITE
      - NET_BIND_SERVICE
      # Needed for named pipes in audit
      - MKNOD

    # Prevent container escape
    pids_limit: 100

    # Ulimits to prevent fork bombs
    ulimits:
      nproc: 50
      nofile:
        soft: 4096
        hard: 8192

    # Restart policy
    restart: unless-stopped

    # Environment
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - PRISM_PTX_DIR=/opt/prism4d/kernels/ptx
      - PRISM_OPTIXIR_DIR=/opt/prism4d/kernels/optixir

    # Logging limits (container stdout/stderr)
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  demo-results:
    driver: local
