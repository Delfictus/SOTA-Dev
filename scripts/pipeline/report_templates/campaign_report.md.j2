# PRISM-4D Campaign Report

**Project:** {{ project_name }}
**Target:** {{ target_name }}
**PDB:** {{ pdb_id }}
**Generated:** {{ timestamp }}

---

## Pipeline Summary

| Stage | Status | Duration |
|-------|--------|----------|
{% for stage in stages %}
| {{ stage.stage_name }} | {{ stage.status }} | {{ "%.1f"|format(stage.duration_seconds) }}s |
{% endfor %}

**Total Pipeline Time:** {{ "%.1f"|format(total_duration_seconds) }}s

## Anti-Leakage Audit

| Check | Result |
|-------|--------|
| Audit Clean | {{ "PASS" if audit_clean else "**FAIL**" }} |
| Input PDB Hash | `{{ input_pdb_hash[:16] }}...` |
{% if not audit_clean %}

### Violations
{% for v in audit_violations %}
- {{ v }}
{% endfor %}
{% endif %}

{% if has_pocket_data %}
## Pocket Analysis

| Metric | Value |
|--------|-------|
| Stability | **{{ pocket_stability }}** |
| RMSD (mean) | {{ "%.2f"|format(pocket_rmsd_mean) }} A |
| Volume (mean) | {{ "%.0f"|format(pocket_volume_mean) }} A^3 |
{% if p_open is not none %}
| P_open | {{ "%.3f"|format(p_open) }} +/- {{ "%.3f"|format(p_open_error) }} |
| Druggability | {{ druggability_classification }} |
{% endif %}
{% if n_displaceable_waters is not none %}
| Structural Waters | {{ n_structural_waters }} |
| Displaceable Waters | {{ n_displaceable_waters }} |
| Total Displacement Energy | {{ "%.1f"|format(total_displacement_energy) }} kcal/mol |
{% endif %}
{% endif %}

## Generation Summary

| Metric | Value |
|--------|-------|
| Molecules Generated | {{ n_generated }} |
| After Filtering | {{ n_filtered }} |
| Top N Selected | {{ top_n }} |

{% if candidates %}
## Top Candidates

| Rank | Compound ID | Source | QED | SA | dG (GBSA) | dG (FEP) | Classification |
|------|-------------|--------|-----|----|-----------|-----------| ---------------|
{% for c in candidates %}
| {{ loop.index }} | {{ c.compound_id }} | {{ c.source }} | {{ "%.2f"|format(c.qed_score) }} | {{ "%.1f"|format(c.sa_score) }} | {{ c.ensemble_dg if c.ensemble_dg else "N/A" }} | {{ c.fep_dg if c.fep_dg else "N/A" }} | {{ c.classification if c.classification else "PENDING" }} |
{% endfor %}
{% endif %}

{% if novel_hits %}
## Novel Hits

{% for hit in novel_hits %}
### {{ hit.compound_id }}

- **SMILES:** `{{ hit.smiles }}`
- **dG (FEP):** {{ "%.2f"|format(hit.fep_dg_bind) }} +/- {{ "%.2f"|format(hit.fep_dg_error) }} kcal/mol
- **Pharmacophore Match:** {{ hit.spike_pharmacophore_match }}
- **Novelty:** Tanimoto {{ "%.3f"|format(hit.tanimoto) }} to nearest known (CID {{ hit.nearest_cid }})

{% endfor %}
{% endif %}

## Classification Summary

| Category | Count |
|----------|-------|
{% for cat, count in classification_counts.items() %}
| {{ cat }} | {{ count }} |
{% endfor %}

---

## Residue Mapping

{% if residue_mappings %}
| PDB Residue | Topology ID | UniProt Position |
|-------------|-------------|------------------|
{% for r in residue_mappings %}
| {{ r.pdb_name }} | {{ r.topology_id }} | {{ r.uniprot_pos }} |
{% endfor %}
{% else %}
*No residue mapping data available.*
{% endif %}

---
*Report generated by PRISM-4D Pipeline v1.0*
*Anti-leakage audit: {{ "CLEAN" if audit_clean else "VIOLATIONS DETECTED" }}*
